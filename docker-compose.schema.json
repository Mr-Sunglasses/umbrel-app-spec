{
    "$schema": "https://json-schema.org/draft-07/schema",
    "title": "Umbrel Docker Compose Configuration",
    "markdownDescription": "Docker Compose configuration for Umbrel apps. This is a permissive schema that provides help and autocompletion for Umbrel-specific features without strict validation.",
    "type": "object",
    "properties": {
        "version": {
            "title": "Docker Compose Version",
            "markdownDescription": "Umbrel requires exactly version 3.7",
            "type": "string",
            "default": "3.7"
        },
        "services": {
            "title": "Services",
            "markdownDescription": "Container services for the application. Umbrel supports any valid Docker Compose service configuration with special help for Umbrel-specific features.",
            "type": "object",
            "patternProperties": {
                "^[a-zA-Z0-9._-]+$": {
                    "type": "object",
                    "oneOf": [
                        {
                            "title": "Umbrel App Proxy Service",
                            "markdownDescription": "Umbrel's proxy service for routing and authentication. Use 'app_proxy' as the service name for automatic configuration.",
                            "properties": {
                                "environment": {
                                    "title": "App Proxy Configuration",
                                    "markdownDescription": "**Umbrel App Proxy Environment Variables:**\n\n**Required:**\nâ€¢ `APP_HOST` - DNS name of web container (format: imagename_servicename_1)\nâ€¢ `APP_PORT` - Internal port app listens on (string or integer)\n\n**Optional:**\nâ€¢ `PROXY_AUTH_ADD` - Set to 'false' to disable authentication while keeping proxy active\nâ€¢ `PROXY_AUTH_WHITELIST` - URL paths to bypass authentication (e.g., '/api/*')\nâ€¢ `PROXY_AUTH_BLACKLIST` - URL paths to require authentication (e.g., '/admin/*')",
                                    "type": "object",
                                    "properties": {
                                        "APP_HOST": {
                                            "title": "App Host",
                                            "markdownDescription": "DNS name of the web container. Example: 'myapp_web_1'",
                                            "type": "string",
                                            "examples": ["myapp_web_1", "akaunting_app_1", "nginx_server_1"]
                                        },
                                        "APP_PORT": {
                                            "title": "App Port",
                                            "markdownDescription": "Internal port the app listens on. Can be string or integer.",
                                            "type": ["string", "integer"],
                                            "examples": [80, 3000, "8080", "9000"]
                                        },
                                        "PROXY_AUTH_ADD": {
                                            "title": "Disable Authentication",
                                            "markdownDescription": "Set to 'false' to disable Umbrel authentication while keeping proxy active.",
                                            "type": "string",
                                            "enum": ["false"]
                                        },
                                        "PROXY_AUTH_WHITELIST": {
                                            "title": "Auth Whitelist",
                                            "markdownDescription": "URL paths to bypass authentication (comma separated or multiple lines).",
                                            "type": "string",
                                            "examples": ["/api/*", "/public/*,/health", "/webhooks/*,/metrics"]
                                        },
                                        "PROXY_AUTH_BLACKLIST": {
                                            "title": "Auth Blacklist",
                                            "markdownDescription": "URL paths to require authentication (comma separated or multiple lines).",
                                            "type": "string",
                                            "examples": ["/admin/*", "/settings,/users", "/api/admin/*"]
                                        }
                                    }
                                }
                            }
                        },
                        {
                            "title": "Regular Application Service",
                            "markdownDescription": "Standard Docker service with optional Umbrel environment variables and volume mounts.",
                            "properties": {
                                "volumes": {
                                    "title": "Volume Mounts",
                                    "markdownDescription": "**Umbrel Storage Variables:**\n\n**App Storage:**\nâ€¢ `${APP_DATA_DIR}/` - App-specific data directory\nâ€¢ `${APP_LIGHTNING_NODE_DATA_DIR}` - Lightning node data\nâ€¢ `${APP_BITCOIN_DATA_DIR}` - Bitcoin node data\n\n**Communal Storage (requires STORAGE_DOWNLOADS permission):**\nâ€¢ `${UMBREL_ROOT}/data/storage/` - Shared storage area\n\n**Examples:**\nâ€¢ `${APP_DATA_DIR}/data:/app/data`\nâ€¢ `${UMBREL_ROOT}/data/storage/downloads:/downloads`\nâ€¢ `${APP_LIGHTNING_NODE_DATA_DIR}:/lnd:ro`",
                                    "type": "array",
                                    "items": {
                                        "type": "string"
                                    },
                                    "examples": [
                                        "${APP_DATA_DIR}/data:/app/data",
                                        "${APP_DATA_DIR}/config:/etc/app:ro",
                                        "${UMBREL_ROOT}/data/storage/downloads:/downloads",
                                        "${UMBREL_ROOT}/data/storage/media:/media:rw",
                                        "${APP_LIGHTNING_NODE_DATA_DIR}:/lnd:ro",
                                        "${APP_BITCOIN_DATA_DIR}:/bitcoin:ro"
                                    ]
                                },
                                "environment": {
                                    "title": "Environment Variables",
                                    "markdownDescription": "**Umbrel Special Variables:**\n\n**System Level:**\nâ€¢ `$DEVICE_HOSTNAME` - Server hostname (e.g., \"umbrel\") ðŸ’¡ Display device name in UI\nâ€¢ `$DEVICE_DOMAIN_NAME` - .local domain (e.g., \"umbrel.local\") ðŸ’¡ Create links to services\n\n**Tor Proxy:**\nâ€¢ `$TOR_PROXY_IP` - Local Tor SOCKS proxy IP ðŸ’¡ Route traffic through Tor\nâ€¢ `$TOR_PROXY_PORT` - Tor proxy port (typically 9050) ðŸ’¡ Combine with $TOR_PROXY_IP\n\n**App Specific:**\nâ€¢ `$APP_HIDDEN_SERVICE` - App's .onion address ðŸ’¡ Display for anonymous Tor access\nâ€¢ `$APP_PASSWORD` - Random password shown in Umbrel UI ðŸ’¡ Use for authentication\nâ€¢ `$APP_SEED` - 256-bit seed from user's Umbrel seed ðŸ’¡ Generate deterministic keys",
                                    "type": "object",
                                    "patternProperties": {
                                        "^[A-Z_][A-Z0-9_]*$": {}
                                    },
                                    "examples": [
                                        {
                                            "DEVICE_HOSTNAME": "$DEVICE_HOSTNAME",
                                            "TOR_PROXY_CONFIG": "$TOR_PROXY_IP:$TOR_PROXY_PORT",
                                            "APP_AUTH_PASSWORD": "$APP_PASSWORD",
                                            "APP_TOR_ADDRESS": "$APP_HIDDEN_SERVICE",
                                            "DETERMINISTIC_KEY": "derived_from_$APP_SEED",
                                            "DB_PORT": 3306,
                                            "ENABLE_FEATURE": true,
                                            "APP_NAME": "My Awesome App"
                                        }
                                    ]
                                }
                            }
                        }
                    ]
                }
            }
        }
    },
    "required": ["version", "services"],
    "examples": [
        {
            "title": "Simple Web App",
            "description": "Basic web app with Umbrel app proxy",
            "compose": {
                "version": "3.7",
                "services": {
                    "web": {
                        "image": "nginx:alpine",
                        "volumes": ["${APP_DATA_DIR}/html:/usr/share/nginx/html"]
                    },
                    "app_proxy": {
                        "environment": {
                            "APP_HOST": "web_1",
                            "APP_PORT": 80
                        }
                    }
                }
            }
        },
        {
            "title": "App with Database and Tor",
            "description": "Multi-service app with database and Tor integration",
            "compose": {
                "version": "3.7",
                "services": {
                    "app": {
                        "image": "myapp:latest",
                        "environment": {
                            "DEVICE_NAME": "$DEVICE_HOSTNAME",
                            "DB_PORT": 3306,
                            "USE_TOR": "true",
                            "TOR_PROXY": "$TOR_PROXY_IP:$TOR_PROXY_PORT",
                            "ADMIN_PASSWORD": "$APP_PASSWORD"
                        },
                        "volumes": [
                            "${APP_DATA_DIR}/data:/app/data",
                            "${UMBREL_ROOT}/data/storage/uploads:/uploads"
                        ],
                        "depends_on": ["db"]
                    },
                    "db": {
                        "image": "mysql:8",
                        "environment": {
                            "MYSQL_ROOT_PASSWORD": "secret",
                            "MYSQL_DATABASE": "myapp"
                        },
                        "volumes": ["${APP_DATA_DIR}/mysql:/var/lib/mysql"]
                    },
                    "app_proxy": {
                        "environment": {
                            "APP_HOST": "app_1",
                            "APP_PORT": 3000,
                            "PROXY_AUTH_WHITELIST": "/api/*,/health"
                        }
                    }
                }
            }
        }
    ]
}